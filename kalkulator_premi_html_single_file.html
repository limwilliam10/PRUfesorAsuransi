<!DOCTYPE html>
<html lang="id">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Kalkulator Premi Asuransi Jiwa</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  
  <style>
    :root{
      --bg:#faf9fb;
      --card:#ffffff;
      --ink:#1f2330;
      --muted:#6b7280;
      --brand:#3c0b2b; /* maroon */
      --brand-2:#8b1c49; /* accent */
      --stroke:#e6e6ea;
      --focus:#bba2c3;
      --ok:#e3f6ef;
      --warn:#fde2e2;
      --radius:16px;
    }
    #kalkulator-premi-container *{box-sizing:border-box}
    html,#kalkulator-premi-container {height:100%}
    #kalkulator-premi-container {
      margin:0; background:var(--bg); color:var(--ink); font-family:Inter,system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      line-height:1.45;
    }
    #kalkulator-premi-container .wrap{max-width:980px; margin:24px auto 80px; padding:0 16px}

    /* Header */
    #kalkulator-premi-container .title{font-weight:800; font-size:22px; letter-spacing:.2px; margin:8px 0 14px}
    #kalkulator-premi-container .subtitle{color:var(--muted); font-size:13px; margin-bottom:18px}

    /* Card */
    #kalkulator-premi-container .card{background:var(--card); border:1px solid var(--stroke); border-radius:var(--radius); box-shadow:0 5px 18px rgba(28,18,48,.05); overflow:hidden}
    #kalkulator-premi-container .cardHeader{padding:18px 18px 0}
    #kalkulator-premi-container .grid{display:grid; grid-template-columns:1fr; gap:12px; padding:18px}
    @media(min-width:720px){#kalkulator-premi-container .grid{grid-template-columns:repeat(2,1fr)} }
    @media(min-width:960px){#kalkulator-premi-container .grid{grid-template-columns:repeat(3,1fr)} }

    label{font-size:12px; color:var(--muted); font-weight:600; letter-spacing:.2px}
    #kalkulator-premi-container .field{display:flex; flex-direction:column; gap:6px}
    #kalkulator-premi-container .input, select, input[type="date"]{height:38px; width:100%; border:1px solid var(--stroke); border-radius:10px; padding:8px 10px; font-size:14px; outline:none; background:#fff}
    #kalkulator-premi-container .input:focus, select:focus, input[type="date"]:focus{border-color:#cdb4d9; box-shadow:0 0 0 4px rgba(187,162,195,.18)}

    #kalkulator-premi-container .split{display:flex; align-items:center; gap:10px}
    #kalkulator-premi-container .split .unit{color:var(--muted); font-size:13px}
    #kalkulator-premi-container .split .input{flex:1}

    #kalkulator-premi-container .actions{display:flex; justify-content:center; padding:10px 18px 22px}
    #kalkulator-premi-container .btn{appearance:none; border:none; background:var(--brand); color:#fff; height:40px; padding:0 18px; border-radius:10px; font-weight:700; letter-spacing:.2px; cursor:pointer}
    #kalkulator-premi-container .btn:hover{background:#2d081f}

    /* Results */
    #kalkulator-premi-container .results{display:grid; grid-template-columns:1fr; gap:14px; margin-top:18px; padding:0 18px 18px}
    @media(min-width:720px){#kalkulator-premi-container .results{grid-template-columns:repeat(3,1fr)} }
    #kalkulator-premi-container .resultCard{border:1px solid var(--stroke); border-radius:14px; padding:14px}
    #kalkulator-premi-container .resultCard h4{margin:0 0 6px; font-size:12px; color:var(--muted); letter-spacing:.2px}
    #kalkulator-premi-container .resultCard .value{font-size:20px; font-weight:800}
    #kalkulator-premi-container .accent-warn{background:var(--warn)}
    #kalkulator-premi-container .accent-ok{background:var(--ok)}
    #kalkulator-premi-container .muted{color:var(--muted)}

    #kalkulator-premi-container .footer{display:flex; justify-content:space-between; align-items:center; gap:8px; padding:18px; border-top:1px dashed var(--stroke); font-size:12px; color:var(--muted)}
    #kalkulator-premi-container .link{color:var(--brand-2); text-decoration:none; font-weight:700}
    #kalkulator-premi-container .tiny{font-size:11px}

    #kalkulator-premi-container .powered{padding:12px 18px; text-align:center; color:#b45475; font-weight:700}

    /* --- CSS UNTUK LOADER --- */
    #kalkulator-premi-container .loader-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(255, 255, 255, 0.7);
      z-index: 200;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(2px); /* Efek blur opsional */
    }
    #kalkulator-premi-container .spinner {
      width: 50px;
      height: 50px;
      border: 5px solid #e6e6ea; /* Warna track spinner */
      border-top: 5px solid var(--brand); /* Warna utama spinner */
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Utilities used by filter/search scripting */
    #kalkulator-premi-container .hide{display:none !important}
      /* Floating Results (hidden by default) */
    /* legacy float style removed to avoid conflicts */
    #kalkulator-premi-container .floatResults .results{margin:12px 0 0; padding:0; width:100%; box-sizing:border-box; grid-template-columns:repeat(auto-fit, minmax(220px, 1fr));}
    
      /* Floating modal overrides */
    #kalkulator-premi-container .floatResults{position:fixed; top:50%; left:50%; transform:translate(-50%,-50%) scale(1); transform-origin:center center; width:min(900px,92vw); max-width:calc(100dvw - 24px); overflow:hidden; background:var(--card); border:1px solid var(--stroke); border-radius:var(--radius); box-shadow:0 24px 60px rgba(31,35,48,.28); z-index:100; will-change:transform; box-sizing:border-box}
    #kalkulator-premi-container .floatResults .floatBody{padding:16px}
    #kalkulator-premi-container .floatResults .results{margin:12px 0 0; padding:0; width:100%; box-sizing:border-box; grid-template-columns:repeat(auto-fit, minmax(220px, 1fr));}
    #kalkulator-premi-container .closeBtn{position:absolute; top:8px; right:10px; border:none; background:transparent; font-size:22px; line-height:1; cursor:pointer; color:#9aa0aa}
    #kalkulator-premi-container .closeBtn:hover{color:#5b616a}
    #kalkulator-premi-container .summaryGrid{display:grid; grid-template-columns:repeat(3,1fr); gap:10px}
    #kalkulator-premi-container .summaryGrid .item{border:1px dashed var(--stroke); border-radius:10px; padding:8px 10px}
    #kalkulator-premi-container .summaryGrid .label{display:block; font-size:11px; color:var(--muted); letter-spacing:.2px}
    #kalkulator-premi-container .summaryGrid .val{font-weight:700}
    #kalkulator-premi-container .modalBackdrop{position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:90}
    @media(max-width:960px){#kalkulator-premi-container .summaryGrid{grid-template-columns:repeat(2,1fr)} }
    @media(max-width:640px){#kalkulator-premi-container .summaryGrid{grid-template-columns:1fr} }
      /* Errors */
    #kalkulator-premi-container .error{border-color:#ef4444 !important; box-shadow:0 0 0 4px rgba(239,68,68,.15) !important}
    #kalkulator-premi-container .errorMsg{color:#dc2626; font-size:12px; margin-top:4px}
      /* Force visual order dd/mm/yyyy for WebKit/Blink (Chrome/Edge/Samsung Internet) */
    input[type="date"]::-webkit-datetime-edit { display:flex; }
    input[type="date"]::-webkit-datetime-edit-fields-wrapper{ display:flex; }
    input[type="date"]::-webkit-datetime-edit-day-field{ order:1; }
    input[type="date"]::-webkit-datetime-edit-month-field{ order:2; }
    input[type="date"]::-webkit-datetime-edit-year-field{ order:3; }
    input[type="date"]::-webkit-datetime-edit-text{ order:4; }
      /* Date display overlay for dd-Mmm-yyyy */
    #kalkulator-premi-container .dateWrap{position:relative}
    #kalkulator-premi-container .dateWrap .dateNative{color:transparent; caret-color:transparent; position:relative; z-index:2; background:transparent}
    #kalkulator-premi-container .dateWrap .dateDisplay{position:absolute; inset:0; display:flex; align-items:center; padding:0 10px; pointer-events:none; color:var(--ink)}
    #kalkulator-premi-container .dateDisplay.empty{color:var(--muted)}
  </style>
</head>

<body>
<div id="kalkulator-premi-container">
    <div id="loader" class="loader-backdrop hide">
    <div class="spinner"></div>
  </div>
  <div class="wrap">
    <div class="title">Kalkulator Premi Asuransi Jiwa <span class="muted">(Internal USTeams)</span></div>
    <div class="subtitle">Isi data di bawah ini untuk mendapatkan estimasi premi tahunan. Tampilan dirancang menyerupai contoh.</div>

    <!-- FORM CARD -->
    <div class="card" id="formCard" style="margin-top:14px">
      <div class="cardHeader"></div>
      <div class="grid" id="formGrid">
        <div class="field"><label>Nama</label><input id="nama" class="input" placeholder="Ketik di sini…"/></div>
        <div class="field"><label>Nomor Handphone (WhatsApp)</label><input id="wa" class="input" inputmode="numeric" placeholder="0812xxxxxxx"/></div>
        <div class="field"><label>Email Aktif</label><input id="email" class="input" placeholder="nama@domain.com"/></div>
        <div class="field"><label>Jenis Kelamin</label>
          <select id="gender">
            <option disabled selected value="">Pilih</option>
            <option value="Pria">Pria</option>
            <option value="Wanita">Wanita</option>
          </select>
        </div>
        <div class="field"><label>Tanggal Lahir</label>
          <div class="dateWrap">
            <input id="dob" type="date" class="input dateNative" lang="id-ID"/>
            <span id="dobDisplay" class="dateDisplay" aria-hidden="true">dd-Mmm-yyyy</span>
          </div>
        </div>
        <div class="field"><label>Status Merokok</label>
          <select id="smoke">
            <option disabled selected value="">Pilih</option>
            <option value="Perokok">Perokok</option>
            <option value="Bukan Perokok">Bukan Perokok</option>
          </select>
        </div>
        <div class="field"><label>Nama Produk</label>
          <select id="produk">
            <option disabled selected value="">Pilih</option>
            <option>PRUCritical Amanah (Basic)</option>
            <option>PRUCritical Amanah (Plus)</option>
            <option>PCB88</option>
            <option>PRUAnugerah</option>
            <option>PRUFuture</option>
            <option>PRUCinta</option>
            <option>PRUHeritage</option>
          </select>
        </div>
        <div class="field"><label>Uang Pertanggungan</label>
          <div class="split">
            <span class="unit">Rp</span>
            <input id="up" class="input" inputmode="numeric" placeholder="Contoh: 500.000.000"/>
          </div>
        </div>
        <div class="field"><label>Masa Pembayaran</label>
          <select id="masa">
            <option disabled selected value="">Pilih</option>
            <option>5 tahun</option>
            <option>10 tahun</option>
            <option>15 tahun</option>
          </select>
        </div>
      </div>
      <div class="actions"><button class="btn" id="hitung">Calculate</button></div>

      <div class="powered">Powered by: <a class="link" href="#">www.prufesorasuransi.com</a></div>

      <!-- RESULTS (Floating; shown after Calculate) -->
      <div id="resultsBackdrop" class="modalBackdrop hide"></div>
      <div id="resultsFloat" class="floatResults hide" role="dialog" aria-live="polite" aria-modal="true">
        <button class="closeBtn" id="closeResults" aria-label="Tutup">×</button>
        <div class="floatBody">
          <h3 style="margin:0 0 10px; font-size:16px;">Ringkasan Input</h3>
          <div class="summaryGrid">
            <div class="item"><span class="label">Nama</span><span class="val" id="s_nama">-</span></div>
            <div class="item"><span class="label">Nomor Handphone (WhatsApp)</span><span class="val" id="s_wa">-</span></div>
            <div class="item"><span class="label">Email Aktif</span><span class="val" id="s_email">-</span></div>
            <div class="item"><span class="label">Jenis Kelamin</span><span class="val" id="s_gender">-</span></div>
            <div class="item"><span class="label">Tanggal Lahir</span><span class="val" id="s_dob">-</span></div>
            <div class="item"><span class="label">Status Merokok</span><span class="val" id="s_smoke">-</span></div>
            <div class="item"><span class="label">Nama Produk</span><span class="val" id="s_produk">-</span></div>
            <div class="item"><span class="label">Uang Pertanggungan</span><span class="val" id="s_up">-</span></div>
            <div class="item"><span class="label">Masa Pembayaran</span><span class="val" id="s_masa">-</span></div>
          </div>

          <div class="powered">Powered by: <a class="link" href="#">www.prufesorasuransi.com</a></div>

          <div class="results">
            <div class="resultCard accent-warn">
              <h4>Estimasi premi (sebelum diskon)</h4>
              <div id="premi" class="value">Rp – / tahun</div>
            </div>
            <div class="resultCard">
              <h4>Diskon (khusus hari ini)</h4>
              <div class="value"><span id="disc">0</span>%</div>
            </div>
            <div class="resultCard accent-ok">
              <h4>Estimasi premi (setelah diskon)</h4>
              <div id="premiNet" class="value">Rp – / tahun</div>
            </div>
          </div>
        </div>
      </div>

      <div class="footer">
        <div>Made with <a class="link" href="https://rows.com" target="_blank" rel="noreferrer noopener">Rows.com</a></div>
        <div class="tiny">Tampilan prototipe • Untuk estimasi saja</div>
      </div>
    </div>
  </div>
</div>

  <script>
    // Definisikan kontainer di paling atas
    const kalkulatorContainer = document.getElementById('kalkulator-premi-container');

    // Helpers
    const fmtIDR = (n) => n.toLocaleString('id-ID', { style:'currency', currency:'IDR', maximumFractionDigits:0 });
    function getAgeFromDateInput(ymd){
      if(!ymd) return 0; // value from <input type="date"> is yyyy-mm-dd
      const [y,m,d] = ymd.split('-').map(Number);
      if(!y||!m||!d) return 0;
      const today = new Date();
      const tM = today.getMonth() + 1;
      const tD = today.getDate();
      const base = today.getFullYear() - y; // year difference
      const passed = (tM > m) || (tM === m && tD > d);       // ulang tahun SUDAH lewat tahun ini
      const todayIs = (tM === m && tD === d);                // tepat hari ulang tahun

      // Age Last Birthday baseline
      let age = base;
      if(!passed && !todayIs) age = base - 1;                // ulang tahun BELUM lewat → kurangi 1

      // Business rule: jika ulang tahun sudah lewat (strict), gunakan "usia berikutnya"
      if(passed) age = age + 1;

      return Math.max(0, age);
    }

    // URL dari Google Sheet yang sudah di-publish sebagai CSV
    const GOOGLE_SHEET_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQSAJCvm0ndyO4WJr_HZGPtrZE_zxZTKmf_A_bYNbnkUa5KVpEtymfSew5glyl9FQoEOPe4e_XyMOG7/pub?gid=0&single=true&output=csv';
    const GOOGLE_SHEET_DISCOUNT_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQSAJCvm0ndyO4WJr_HZGPtrZE_zxZTKmf_A_bYNbnkUa5KVpEtymfSew5glyl9FQoEOPe4e_XyMOG7/pub?gid=1035821418&single=true&output=csv';
    const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwJGLWDt4d-npwDy_5mpcds8kJE7ivwfqn-n8dcHJa1OluPcASMe1Mb1xTVuFiORqXw/exec';

    // Fungsi baru untuk mengambil data dan mencari premi
    async function estimatePremium({up, age, gender, produk, masa, smoke}) {
      // Pastikan semua input ada
      if (!up || !age || !gender || !produk || !masa || !smoke) return 0;

      try {
        const response = await fetch(GOOGLE_SHEET_URL);
        if (!response.ok) {
          console.error('Gagal mengambil data dari Google Sheet.');
          return 0;
        }

        const csvText = await response.text();
        const rows = csvText.split('\n').map(row => row.split(','));

        // Mencari baris yang cocok dengan 5 kriteria
        // Format di CSV: [Produk, Merokok, Usia, Gender, Masa Bayar, Premi Dasar]
        const foundRow = rows.find(row => 
          row[0] === produk &&         // Kolom A: Nama Produk
          row[1] === smoke &&          // Kolom B: Status Merokok (Y/N)
          row[2] === String(age) &&    // Kolom C: Usia
          row[3] === gender &&         // Kolom D: Jenis Kelamin (L/P)
          row[4] === String(masa)      // Kolom E: Masa Pembayaran (angka)
        );

        if (foundRow) {
          // Kolom F (indeks ke-5) adalah Premi Dasar untuk 1 Miliar
          const basePremium = Number(foundRow[5].replace(/[^0-9]/g, ''));
          
          // Hitung premi proporsional berdasarkan UP yang diinput
          const finalPremium = basePremium * (up / 1000000000);
          return Math.round(finalPremium);

        } else {
          console.warn('Kombinasi data tidak ditemukan di tabel premi.');
          return 0; // Kembalikan 0 jika tidak ada data yang cocok
        }

      } catch (error) {
        console.error('Terjadi error saat memproses data:', error);
        return 0;
      }
    }

    // Fungsi baru untuk mengambil data diskon
    async function getDiscountPercentage({produk, up}) {
      if (!produk || !up) return 0; // Kembalikan 0 jika data tidak lengkap

      try {
        const response = await fetch(GOOGLE_SHEET_DISCOUNT_URL);
        if (!response.ok) {
          console.error('Gagal mengambil data diskon dari Google Sheet.');
          return 0;
        }

        const csvText = await response.text();
        // Hapus baris header dan baris kosong
        const rows = csvText.split('\n').slice(1).filter(row => row).map(row => row.split(','));

        // Mencari baris diskon yang cocok
        // Format di CSV: [Produk, Min UP, Max UP, Diskon]
        const foundRow = rows.find(row => {
          const csvProduk = row[0];
          const csvMinUP = Number(row[1]);
          const csvMaxUP = Number(row[2]);

          // Cek apakah produknya cocok DAN UP berada di dalam rentang
          return produk === csvProduk && up >= csvMinUP && up <= csvMaxUP;
        });

        if (foundRow) {
          // Kolom D (indeks ke-3) adalah persentase diskon
          return Number(foundRow[3]);
        } else {
          console.warn('Skema diskon tidak ditemukan untuk produk dan UP ini.');
          return 0; // Diskon default jika tidak ada yang cocok
        }

      } catch (error) {
        console.error('Terjadi error saat memproses data diskon:', error);
        return 0;
      }
    }

    // Fungsi baru untuk mengirim (log) data ke Google Sheet via Apps Script
    function logDataToSheet(logData) {
      // Kita tidak perlu 'await' proses ini, biarkan berjalan di background agar user tidak perlu menunggu
      fetch(GOOGLE_APPS_SCRIPT_URL, {
        method: 'POST',
        mode: 'no-cors', // Penting untuk menghindari error CORS saat mengirim ke Apps Script
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(logData)
      })
      .then(response => console.log('Log berhasil.'))
      .catch(error => console.error('Log gagal:', error));
    }

    // Ubah fungsi calc menjadi async untuk menunggu hasil dari estimatePremium
    // Ganti seluruh fungsi calc Anda dengan yang ini
    async function calc() {
      if (!validateForm()) {
        const rf = kalkulatorContainer.querySelector('#resultsFloat');
        const rb = kalkulatorContainer.querySelector('#resultsBackdrop');
        if (rf) rf.classList.add('hide');
        if (rb) rb.classList.add('hide');
        return;
      }
      
      const loader = kalkulatorContainer.querySelector('#loader');
      
      try {
        // ---> 1. Tampilkan loader saat perhitungan dimulai
        loader.classList.remove('hide');

        const masaText = kalkulatorContainer.querySelector('#masa').value || '';
        const data = {
          up: Number(kalkulatorContainer.querySelector('#up').value.replace(/[^0-9]/g, '')),
          age: getAgeFromDateInput(kalkulatorContainer.querySelector('#dob').value),
          gender: kalkulatorContainer.querySelector('#gender').value,
          produk: kalkulatorContainer.querySelector('#produk').value,
          masa: parseInt((masaText.match(/[0-9]+/) || [''])[0], 10) || 0,
          smoke: kalkulatorContainer.querySelector('#smoke').value,
        };

        fillSummary();

        const raw = await estimatePremium(data); 
        const discPct = await getDiscountPercentage({ produk: data.produk, up: data.up });
        
        kalkulatorContainer.querySelector('#disc').textContent = discPct;
        
        let net = 0; // Inisialisasi premi final
        if (raw > 0) {
          kalkulatorContainer.querySelector('#premi').textContent = fmtIDR(raw) + ' / tahun';
          const premiSetelahDiskon = raw * (100 - discPct) / 100;
          const net = Math.round(premiSetelahDiskon / 1000) * 1000;
          kalkulatorContainer.querySelector('#premiNet').textContent = fmtIDR(net) + ' / tahun';
        } else {
          kalkulatorContainer.querySelector('#premi').textContent = 'Data tidak ditemukan';
          kalkulatorContainer.querySelector('#premiNet').textContent = 'Data tidak ditemukan';
        }

        // Siapkan data untuk dikirim ke Google Sheet
        const logPayload = {
          nama: kalkulatorContainer.querySelector('#nama').value,
          wa: kalkulatorContainer.querySelector('#wa').value,
          email: kalkulatorContainer.querySelector('#email').value,
          gender: data.gender,
          dob: kalkulatorContainer.querySelector('#dob').value,
          smoke: data.smoke,
          produk: data.produk,
          up: data.up,
          masa: data.masa,
          premiAwal: raw,
          diskon: discPct,
          premiFinal: net,
          userAgent: navigator.userAgent // Info browser dan device
        };
        // Panggil fungsi untuk mengirim data ke log
        logDataToSheet(logPayload);
        // -------------------------
        
        // Tampilkan jendela hasil
        kalkulatorContainer.querySelector('#resultsFloat').classList.remove('hide');
        kalkulatorContainer.querySelector('#resultsBackdrop').classList.remove('hide');
        requestAnimationFrame(fitModal);

      } catch (error) {
        // Jika terjadi error, catat di console dan beritahu user
        console.error("Terjadi kesalahan saat kalkulasi:", error);
        alert("Gagal memproses data. Silakan coba lagi.");
      } finally {
        // ---> 2. Sembunyikan loader setelah semuanya selesai (baik berhasil maupun gagal)
        loader.classList.add('hide');
      }
    }

    // Pastikan event listener tidak berubah
    kalkulatorContainer.querySelector('#hitung').addEventListener('click', calc);

    // FILTER BAR logic
    // Conditional options for Masa Pembayaran berdasarkan Produk
    const masaSel = kalkulatorContainer.querySelector('#masa');
    const produkSel = kalkulatorContainer.querySelector('#produk');
    const defaultMasa = ['5 tahun','10 tahun','15 tahun'];
    function updateMasaOptions(product){
      let opts = defaultMasa;
      if(product === 'PRUCinta'){
        opts = ['10 Tahun'];
      } else if(product === 'PRUHeritage'){
        opts = ['5 tahun','10 tahun','15 tahun','sampai usia 60 tahun','sampai usia 99 tahun'];
      }
      const current = masaSel.value;
      masaSel.innerHTML = '';
      const ph = document.createElement('option');
      ph.value = '';
      ph.textContent = 'Pilih';
      ph.disabled = true; ph.selected = true;
      masaSel.appendChild(ph);
      opts.forEach(t => { const o=document.createElement('option'); o.textContent=t; masaSel.appendChild(o); });
      if(opts.includes(current)){
        masaSel.value = current; ph.selected = false;
      }
    }

    // Trigger update saat produk berubah (di form & filter)
    produkSel.addEventListener('change', e => updateMasaOptions(e.target.value));

    // Set default saat load
    updateMasaOptions(produkSel.value || '');
    
    // --- Input restrictions & formatting ---
    // Uang Pertanggungan: angka saja + thousand separator saat mengetik
    const upField = kalkulatorContainer.querySelector('#up');
    const nfID = new Intl.NumberFormat('id-ID');
    upField.addEventListener('input', () => {
      const digits = upField.value.replace(/\D/g,'');
      upField.value = digits ? nfID.format(Number(digits)) : '';
    });

    // WA: angka saja
    const waField = kalkulatorContainer.querySelector('#wa');
    waField.addEventListener('input', () => {
      waField.value = waField.value.replace(/\D/g,'');
    });
    // --- Validation helpers ---
    function clearErrors(){
      kalkulatorContainer.querySelectorAll('.errorMsg').forEach(function(el){ el.remove(); });
      kalkulatorContainer.querySelectorAll('.error').forEach(function(el){ el.classList.remove('error'); });
    }
    function addError(id, msg){
      var el = kalkulatorContainer.querySelector('#' + id);
      if(!el) return;
      el.classList.add('error');
      var field = el.closest('.field') || el.parentElement;
      var msgEl = document.createElement('div');
      msgEl.setAttribute('class','errorMsg');
      msgEl.textContent = '* ' + msg;
      field.appendChild(msgEl);
    }
    function validateForm(){
      clearErrors();
      var ok = true;
      var required = [
        ['nama','Nama wajib diisi'],
        ['wa','Nomor WA wajib diisi'],
        ['email','Email wajib diisi'],
        ['gender','Jenis kelamin wajib dipilih'],
        ['dob','Tanggal lahir wajib diisi'],
        ['smoke','Status merokok wajib dipilih'],
        ['produk','Nama produk wajib dipilih'],
        ['up','Uang pertanggungan wajib diisi'],
        ['masa','Masa pembayaran wajib dipilih']
      ];
      required.forEach(function(item){
        var id=item[0], msg=item[1];
        var el = kalkulatorContainer.querySelector('#' + id);
        var val = (el && (el.value||'').trim()) || '';
        if(!val){ ok=false; addError(id,msg); }
      });
      var upDigits = (kalkulatorContainer.querySelector('#up').value||'').replace(/\D/g,'');
      if(!upDigits || Number(upDigits) <= 0){ ok=false; addError('up','Masukkan angka lebih dari 0'); }
      var firstErr = kalkulatorContainer.querySelector('.error');
      if(firstErr) firstErr.scrollIntoView({behavior:'smooth', block:'center'});
      return ok;
    }

    // --- Summary helpers ---
    const MONTH_ABBR = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
    const toDisplayDMY = (ymd) => { if(!ymd) return ''; const [y,m,d] = ymd.split('-'); const idx = Math.max(0, Math.min(11, parseInt(m,10)-1)); return `${d}-${MONTH_ABBR[idx]}-${y}`; };
    // Mirror formatted date into overlay span
    const dobInput = kalkulatorContainer.querySelector('#dob');
    const dobDisplay = kalkulatorContainer.querySelector('#dobDisplay');
    function refreshDobDisplay(){
      const ymd = dobInput.value;
      if(ymd){ dobDisplay.textContent = toDisplayDMY(ymd); dobDisplay.classList.remove('empty'); }
      else { dobDisplay.textContent = 'dd-Mmm-yyyy'; dobDisplay.classList.add('empty'); }
    }
    if(dobInput && dobDisplay){
      dobInput.addEventListener('input', refreshDobDisplay);
      dobInput.addEventListener('change', refreshDobDisplay);
      refreshDobDisplay();
    }
    const selText = (id) => { const el = kalkulatorContainer.querySelector('#' + id); return el && el.options[el.selectedIndex] ? el.options[el.selectedIndex].text : ''; };
    function fillSummary(){
      const v = (id) => (kalkulatorContainer.querySelector('#' + id).value || '').trim();
      kalkulatorContainer.querySelector('#s_nama').textContent = v('nama') || '-';
      kalkulatorContainer.querySelector('#s_wa').textContent = v('wa') || '-';
      kalkulatorContainer.querySelector('#s_email').textContent = v('email') || '-';
      kalkulatorContainer.querySelector('#s_gender').textContent = selText('gender') || '-';
      kalkulatorContainer.querySelector('#s_dob').textContent = v('dob') ? toDisplayDMY(v('dob')) : '-';
      kalkulatorContainer.querySelector('#s_smoke').textContent = selText('smoke') || '-';
      kalkulatorContainer.querySelector('#s_produk').textContent = selText('produk') || '-';
      const upVal = v('up');
      kalkulatorContainer.querySelector('#s_up').textContent = upVal ? ('Rp ' + upVal) : '-';
      kalkulatorContainer.querySelector('#s_masa').textContent = selText('masa') || '-';
    }

    // Modal auto-fit to viewport (no internal scrolling)
    function fitModal(){
      const modal = kalkulatorContainer.querySelector('#resultsFloat');
      if(!modal || modal.classList.contains('hide')) return;
      // reset to natural size first
      modal.style.transform = 'translate(-50%,-50%) scale(1)';
      const rect = modal.getBoundingClientRect();
      const vw = Math.min(window.innerWidth || 0, document.documentElement.clientWidth || 0) || window.innerWidth;
      const vh = Math.min(window.innerHeight || 0, document.documentElement.clientHeight || 0) || window.innerHeight;
      const PAD = 24; // breathing room
      const scale = Math.min(1, (vw - PAD) / rect.width, (vh - PAD) / rect.height);
      modal.style.transform = `translate(-50%,-50%) scale(${scale})`;
    }

    // Close / hide handlers
    function hideResults(){
      kalkulatorContainer.querySelector('#resultsFloat').classList.add('hide');
      kalkulatorContainer.querySelector('#resultsBackdrop').classList.add('hide');
    }
    kalkulatorContainer.querySelector('#closeResults').addEventListener('click', hideResults);
    kalkulatorContainer.querySelector('#resultsBackdrop').addEventListener('click', hideResults);
    document.addEventListener('keydown', (e) => { if(e.key === 'Escape') hideResults(); });
    window.addEventListener('resize', fitModal);
    if(window.visualViewport){ window.visualViewport.addEventListener('resize', fitModal); }
    if(document.fonts && document.fonts.ready){ document.fonts.ready.then(fitModal); }
  </script>
</body>
</html>
